# Build and release multi-platform Flutter app
name: Build All Platforms

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  # Android signing configuration (modify here when copying to other projects)
  ANDROID_KEYSTORE_FILE: keystore.jks
  ANDROID_KEYSTORE_SECRET: flexbox123          # Keystore password
  ANDROID_KEY_ALIAS: release                   # Key alias
  ANDROID_KEY_PASSWORD: flexbox123             # Key password
  ANDROID_KEY_DNAME: 'CN=Flexbox Release,O=Flexbox,C=US'  # Certificate info

  # Web build configuration
  WEB_BASE_HREF: /flexbox_layout/              # Base href for web deployment

jobs:
  # Prepare release info
  prepare:
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.tag.outputs.tag }}
      release_name: ${{ steps.tag.outputs.name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate release tag
        id: tag
        run: |
          # Format: YYYYMMDD-shortref (e.g., 20250115-a1b2c3d)
          DATE=$(date +'%Y%m%d')
          SHORT_REF=$(git rev-parse --short HEAD)
          echo "tag=$DATE-$SHORT_REF" >> $GITHUB_OUTPUT
          echo "name=Release $DATE-$SHORT_REF" >> $GITHUB_OUTPUT

  # Android build (multi-architecture)
  build-android:
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      matrix:
        arch: [arm64, x64, universal]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Get dependencies
        run: flutter pub get
        working-directory: example

      - name: Generate Android keystore
        run: |
          cd example/android/app
          # Generate signing keystore
          if [ -n "$KEYSTORE_BASE64" ]; then
            echo "$KEYSTORE_BASE64" | base64 -d > ${{ env.ANDROID_KEYSTORE_FILE }}
          else
            keytool -genkey -v -keystore ${{ env.ANDROID_KEYSTORE_FILE }} \
              -alias ${{ env.ANDROID_KEY_ALIAS }} \
              -keyalg RSA -keysize 2048 -validity 36135 \
              -storepass '${{ env.ANDROID_KEYSTORE_SECRET }}' \
              -keypass '${{ env.ANDROID_KEY_PASSWORD }}' \
              -dname '${{ env.ANDROID_KEY_DNAME }}'
          fi
          # Add to gitignore (if not already added)
          if ! grep -q "${{ env.ANDROID_KEYSTORE_FILE }}" .gitignore 2>/dev/null; then
            echo "${{ env.ANDROID_KEYSTORE_FILE }}" >> .gitignore
          fi
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

      - name: Configure Android signing
        run: |
          cd example/android/app
          # Create signing config file gradle.properties
          printf '\n# Signing config\n' >> gradle.properties
          printf 'RELEASE_STORE_FILE=${{ env.ANDROID_KEYSTORE_FILE }}\n' >> gradle.properties
          printf 'RELEASE_STORE_PASSWORD=${{ env.ANDROID_KEYSTORE_SECRET }}\n' >> gradle.properties
          printf 'RELEASE_KEY_ALIAS=${{ env.ANDROID_KEY_ALIAS }}\n' >> gradle.properties
          printf 'RELEASE_KEY_PASSWORD=${{ env.ANDROID_KEY_PASSWORD }}\n' >> gradle.properties

          # Backup original build.gradle.kts
          cp build.gradle.kts build.gradle.kts.orig

          # Modify build.gradle.kts to add signing config
          # Add signingConfigs inside android {} block
          awk '
          /^android \{/ {
            print
            print ""
            print "    signingConfigs {"
            print "        create(\"release\") {"
            print "            storeFile = file(\"${{ env.ANDROID_KEYSTORE_FILE }}\")"
            print "            storePassword = \"${{ env.ANDROID_KEYSTORE_SECRET }}\""
            print "            keyAlias = \"${{ env.ANDROID_KEY_ALIAS }}\""
            print "            keyPassword = \"${{ env.ANDROID_KEY_PASSWORD }}\""
            print "        }"
            print "    }"
            next
          }
          /signingConfig = signingConfigs.getByName\("debug"\)/ {
            print "            signingConfig = signingConfigs.getByName(\"release\")"
            next
          }
          { print }
          ' build.gradle.kts.orig > build.gradle.kts

      - name: Build APK for ${{ matrix.arch }}
        run: |
          cd example
          if [ "${{ matrix.arch }}" = "universal" ]; then
            flutter build apk --release --target-platform android-arm64,android-x64
          else
            flutter build apk --release --target-platform android-${{ matrix.arch }}
          fi

      - name: Rename APK
        run: |
          cd example/build/app/outputs/flutter-apk
          if [ "${{ matrix.arch }}" = "universal" ]; then
            mv app-release.apk flexbox-android-universal.apk
          else
            mv app-release.apk flexbox-android-${{ matrix.arch }}.apk
          fi

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ matrix.arch }}
          path: |
            example/build/app/outputs/flutter-apk/flexbox-android-${{ matrix.arch }}.apk
            example/build/app/outputs/flutter-apk/flexbox-android-universal.apk
          retention-days: 30
          if-no-files-found: ignore

  # iOS build (requires macOS)
  build-ios:
    runs-on: macos-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get
        working-directory: example

      - name: Build iOS (no codesign)
        run: |
          cd example
          flutter build ios --release --no-codesign

      - name: Create iOS bundle (zip)
        run: |
          cd example
          mkdir -p build/ios-bundle/Runner.app
          cp -r build/ios/iphoneos/Runner.app/* build/ios-bundle/Runner.app/
          cd build/ios-bundle
          zip -r ../../flexbox-ios.zip .
          cd ../..

      - name: Create IPA
        run: |
          cd example
          # Create ipa package structure
          mkdir -p Payload
          cp -r build/ios/iphoneos/Runner.app Payload/
          # Package as ipa
          zip -r flexbox-ios.ipa Payload
          # Cleanup
          rm -rf Payload

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios
          path: |
            example/flexbox-ios.zip
            example/flexbox-ios.ipa
          retention-days: 30

  # Windows build
  build-windows:
    runs-on: windows-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get
        working-directory: example

      - name: Install Inno Setup
        run: |
          choco install innosetup -y

      - name: Build Windows
        run: |
          cd example
          flutter build windows --release

      - name: Create Inno Setup script
        run: |
          $script = @'
          [Setup]
          AppName=FlexBox
          AppVersion=1.0.0
          DefaultDirName={pf}\FlexBox
          DefaultGroupName=FlexBox
          OutputBaseFilename=flexbox-windows-setup
          Compression=lzma2
          SolidCompression=yes
          OutputDir=..\..\

          [Files]
          Source: "build\windows\x64\runner\Release\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs

          [Icons]
          Name: "{group}\FlexBox"; Filename: "{app}\flexbox.exe"
          Name: "{commondesktop}\FlexBox"; Filename: "{app}\flexbox.exe"
          '@
          $script | Out-File -FilePath example\flexbox-setup.iss -Encoding UTF8

      - name: Create installer with Inno Setup
        run: |
          cd example
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" flexbox-setup.iss

      - name: Create Windows zip
        run: |
          cd example
          Compress-Archive -Path build\windows\x64\runner\Release\* -DestinationPath flexbox-windows.zip

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: |
            example/flexbox-windows.zip
            flexbox-windows-setup.exe
          retention-days: 30
          if-no-files-found: ignore

  # Linux build
  build-linux:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev

      - name: Get dependencies
        run: flutter pub get
        working-directory: example

      - name: Build Linux
        run: |
          cd example
          flutter build linux --release

      - name: Create Linux tarball
        run: |
          cd example
          tar -czf flexbox-linux.tar.gz -C build/linux/x64/release/bundle .

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux
          path: example/flexbox-linux.tar.gz
          retention-days: 30

  # macOS build
  build-macos:
    runs-on: macos-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get
        working-directory: example

      - name: Build macOS
        run: |
          cd example
          flutter build macos --release

      - name: Create macOS zip
        run: |
          cd example
          cd build/macos/Build/Products/Release
          zip -r ../../../../../flexbox-macos.zip .

      - name: Create DMG
        run: |
          cd example
          # Create temporary directory
          mkdir -p dmg/disk
          # Copy app to temporary directory
          cp -r build/macos/Build/Products/Release/*.app dmg/disk/
          # Create dmg
          hdiutil create -volname "FlexBox" -srcfolder dmg/disk -ov -format UDZO flexbox-macos.dmg
          # Cleanup
          rm -rf dmg

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos
          path: |
            example/flexbox-macos.zip
            example/flexbox-macos.dmg
          retention-days: 30

  # Web build
  build-web:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get
        working-directory: example

      - name: Build web
        run: flutter build web --release --base-href ${{ env.WEB_BASE_HREF }}
        working-directory: example

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: example/build/web

  # Deploy to GitHub Pages
  deploy-web:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-web
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # Release all builds
  release:
    runs-on: ubuntu-latest
    needs: [prepare, build-android, build-ios, build-windows, build-linux, build-macos]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded artifacts
        run: |
          echo "=== Artifact tree ==="
          tree artifacts/ || ls -laR artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare.outputs.release_tag }}
          name: ${{ needs.prepare.outputs.release_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            artifacts/android-arm64/*.apk
            artifacts/android-x64/*.apk
            artifacts/android-universal/*.apk
            artifacts/ios/*.ipa
            artifacts/ios/*.zip
            artifacts/windows/**/*.exe
            artifacts/windows/**/*.zip
            artifacts/linux/*.tar.gz
            artifacts/macos/*.dmg
            artifacts/macos/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create release summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'SUMMARY'
          # âœ… Release Created Successfully

          ## Tag: ${{ needs.prepare.outputs.release_tag }}

          ## Artifacts

          | Platform | Format | File |
          |----------|--------|------|
          | Android (arm64) | .apk | flexbox-android-arm64.apk |
          | Android (x64) | .apk | flexbox-android-x64.apk |
          | Android (Universal) | .apk | flexbox-android-universal.apk |
          | iOS | .ipa | flexbox-ios.ipa |
          | iOS | .zip | flexbox-ios.zip |
          | Windows | .exe | flexbox-windows-setup.exe |
          | Windows | .zip | flexbox-windows.zip |
          | Linux | .tar.gz | flexbox-linux.tar.gz |
          | macOS | .dmg | flexbox-macos.dmg |
          | macOS | .zip | flexbox-macos.zip |
          SUMMARY
